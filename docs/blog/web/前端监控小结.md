---
meta:
    - title: å‰ç«¯ç›‘æ§å°ç»“
      time: 2021-10-26 14:19:28
      tag: html
---

# å‰ç«¯ç›‘æ§

å‰ç«¯ç›‘æ§åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. æ€§èƒ½ç›‘æ§
2. é”™è¯¯ç›‘æ§
3. è¡Œä¸ºæ•°æ®ä¸ŠæŠ¥
4. å…¶ä»–...

<!-- more -->

## å‰è¨€

## æ€§èƒ½ç›‘æ§

æ€§èƒ½ç›‘æ§çš„æŒ‡æ ‡ä¸€èˆ¬æœ‰ `FP`, `FCP`, `LCP`, `FID`, `CLS` ç­‰ç­‰ï¼Œå…¶ä¸­ä¸€äº›å·²ç»è¢«æµè§ˆå™¨æ ‡å‡†åŒ–å¹¶ä¸”æœ‰ç›¸å…³ `api` ç›´æ¥è·å–ã€‚

<!-- more -->

### FP å’Œ FCP

1. `FP`(`first-paint`) ï¼Œä»é¡µé¢åŠ è½½å¼€å§‹åˆ°ç¬¬ä¸€ä¸ªåƒç´ ç»˜åˆ¶åˆ°å±å¹•ä¸Šçš„æ—¶é—´
2. `FCP`(`first-contentful-paint`)ï¼Œé¡µé¢åŠ è½½åˆ°å±å¹•ä¸Šé¦–æ¬¡æœ‰æ¸²æŸ“å†…å®¹çš„è¿‡ç¨‹ï¼Œè¿™é‡Œçš„å†…å®¹å¯ä»¥æ˜¯æ–‡æœ¬ã€å›¾åƒã€ `svg` å…ƒç´ å’Œéç™½è‰² `canvas` å…ƒç´ ã€‚

`FP` å’Œ `FCP` åŒºåˆ«åœ¨äº `FCP` æ˜¯ç¬¬ä¸€æ¬¡ `dom` ç»˜åˆ¶åˆ°å±å¹•ä¸Šçš„æ—¶é—´ï¼Œä½†å®ƒä»¬å¤§å¤šæ•°æ—¶å€™æ˜¯ä¸€æ ·çš„ã€‚ç«™ç‚¹åº”è¯¥åŠªåŠ›å°†é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ§åˆ¶åœ¨ `1.8` ç§’ä»¥å†…ï¼Œå¹¶å– `75` çš„ç™¾åˆ†æ¯”æ•°æ®ã€‚

é€šè¿‡ [PerformanceObserver](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver) å¯ä»¥è·å–è¿™ä¸¤ä¸ªæŒ‡æ ‡ã€‚

```js
const entryHandler = list => {
    for (const entry of list.getEntries()) {
        console.log(entry);
    }

    observer.disconnect();
};

const observer = new PerformanceObserver(entryHandler);
// buffered å±æ€§è¡¨ç¤ºæ˜¯å¦è§‚å¯Ÿç¼“å­˜æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´è§‚å¯Ÿä»£ç æ·»åŠ æ—¶æœºæ¯”äº‹æƒ…è§¦å‘æ—¶æœºæ™šä¹Ÿæ²¡å…³ç³»ã€‚
observer.observe({ type: 'paint', buffered: true });
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```json
// first-paint
{
    "name": "first-paint",
    "entryType": "paint",
    "startTime": 1075.7000000029802,
    "duration": 0
}

// first-contentful-paint
{
    "name": "first-contentful-paint",
    "entryType": "paint",
    "startTime": 1075.7000000029802,
    "duration": 0
}
```

å¦‚æœä¸æ”¯æŒ `PerformanceObserver` ï¼Œå¯ä»¥ä½¿ç”¨ `performance.getEntriesByType()` ä»£æ›¿ï¼ŒåŒºåˆ«åœ¨äºè¿™é‡Œå¹¶éé‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚

```js
const entries = performance.getEntriesByType('paint');
```

### LCP

`LCP`(`largest-contentful-paint`) ï¼Œä»é¡µé¢åŠ è½½å¼€å§‹åˆ°æœ€å¤§æ–‡æœ¬å—æˆ–å›¾åƒå…ƒç´ åœ¨å±å¹•ä¸Šå®Œæˆæ¸²æŸ“çš„æ—¶é—´ã€‚ç½‘ç«™åº”è¯¥åŠªåŠ›å°†æœ€å¤§å†…å®¹ç»˜åˆ¶æ§åˆ¶åœ¨ `2.5` ç§’ä»¥å†…ï¼Œå¹¶å– `75` çš„ç™¾åˆ†æ¯”æ•°æ®ã€‚

```js
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'largest-contentful-paint', buffered: true });

// æˆ–è€…
const entries = performance.getEntriesByType('largest-contentful-paint');
```

> åŒä¸€é¡µé¢çš„ `LCP` è®°å½•å¯èƒ½æœ‰å¤šä¸ªã€‚è¿™æ˜¯å› ä¸ºç½‘é¡µå¯èƒ½æ˜¯åˆ†é˜¶æ®µæ¸²æŸ“çš„ï¼Œä¾‹å¦‚æœ€å¼€å§‹ `LCP` è®°å½•ä¸€ä¸ªæœ€å¤§çš„æ–‡å­—å—ï¼Œåæ¥å›¾ç‰‡æ¸²æŸ“å¥½åï¼Œåˆè®°å½•ä¸€ä¸ªæ›´å¤§çš„å›¾ç‰‡ã€‚

`LCP` å¯ä»¥çœ‹ä½œ [First Meaningful Paint é¦–æ¬¡æœ‰æ•ˆç»˜åˆ¶ (FMP)](https://web.dev/first-meaningful-paint/)æ›¿ä»£ã€‚

`FMP` å¹¶æ²¡æœ‰ä¸€ä¸ªå‡†ç¡®çš„æµ‹é‡æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªå¾ˆéš¾ç»Ÿä¸€çš„è§„èŒƒï¼Œæ ¹æ®ç ”ç©¶ï¼šæ›´å‡†ç¡®åœ°æµ‹é‡é¡µé¢ä¸»è¦å†…å®¹åŠ è½½å®Œæ¯•çš„æ—¶é—´ç‚¹çš„æ–¹æ³•æ˜¯æŸ¥çœ‹æœ€å¤§å…ƒç´ å®Œæˆæ¸²æŸ“çš„æ—¶é—´ç‚¹ã€‚

`LCP` æµ‹é‡çš„ `dom` å…ƒç´ ä¸ºä»¥ä¸‹å‡ ç§ï¼Œä½†åœ¨æœªæ¥å¯èƒ½ä¼šæ·»åŠ æ›´å¤šçš„å…ƒç´ ï¼š

1. `<img>`å…ƒç´ 
2. å†…åµŒåœ¨ `<svg>` å…ƒç´ å†…çš„ `<image>` å…ƒç´ 
3. `<video>` å…ƒç´ ï¼ˆä½¿ç”¨å°é¢å›¾åƒï¼‰
4. é€šè¿‡ `url()` å‡½æ•°ï¼ˆè€Œéä½¿ç”¨ `CSS` æ¸å˜ï¼‰åŠ è½½çš„å¸¦æœ‰èƒŒæ™¯å›¾åƒçš„å…ƒç´ 
5. åŒ…å«æ–‡æœ¬èŠ‚ç‚¹æˆ–å…¶ä»–è¡Œå†…çº§æ–‡æœ¬å…ƒç´ å­å…ƒç´ çš„å—çº§å…ƒç´ ã€‚

### FID

`FID`(`first-input-delay`)ï¼Œä»ç”¨æˆ·ç¬¬ä¸€æ¬¡ä¸é¡µé¢äº¤äº’ï¼ˆä¾‹å¦‚ï¼Œå½“ä»–ä»¬ç‚¹å‡»é“¾æ¥ï¼Œç‚¹å‡»æŒ‰é’®ï¼Œæˆ–ä½¿ç”¨è‡ªå®šä¹‰çš„ `JavaScript` é©±åŠ¨çš„æ§ä»¶ï¼‰åˆ°æµè§ˆå™¨å®é™…èƒ½å¤Ÿå¼€å§‹å“åº”è¯¥äº¤äº’çš„æ—¶é—´ã€‚ä¸ºäº†æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œç«™ç‚¹åº”è¯¥åŠªåŠ›ä½¿ `FID` ä¿æŒåœ¨ `100` æ¯«ç§’ä»¥å†…ï¼Œå¹¶å– `95-99` çš„ç™¾åˆ†æ¯”æ•°æ®ã€‚

```js
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'first-input', buffered: true });

// æˆ–è€…
const entries = performance.getEntriesByType('first-input');
```

```json
{
    "name": "mousedown",
    "entryType": "first-input",
    "startTime": 20990.90000000596,
    "duration": 16,
    "processingStart": 21001.5,
    "processingEnd": 21001.90000000596,
    "cancelable": true
}
```

å…¶ä¸­ `FID = processingStart - startTime`

### CLS

`CLS`(`cumulative-layout-shift`)ï¼Œç”¨äºè¡¨ç¤ºè§†è§‰çš„ç¨³å®šæ€§ï¼Œè¡¡é‡é¡µé¢çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå‘ç”Ÿçš„æ¯æ¬¡å¸ƒå±€å˜åŒ–ä¸­çš„æœ€å¤§å¹…åº¦çš„å¸ƒå±€å˜åŒ–å¾—åˆ†çš„æŒ‡æ ‡ã€‚ä¸ºäº†æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œç«™ç‚¹åº”è¯¥åŠªåŠ›ä½¿ `CLS` åˆ†æ•°è¾¾åˆ° `0.1` æˆ–æ›´ä½ï¼Œå¹¶å– `75` çš„ç™¾åˆ†æ¯”æ•°æ®ã€‚

å½“ä¸€ä¸ªå¯è§å…ƒç´ åœ¨ä¸¤ä¸ªæ¸²æŸ“å¸§ä¹‹é—´äº§ç”Ÿäº†ä½ç§»ï¼Œå°±ä¼šè§¦å‘ **å¸ƒå±€åç§»**ã€‚

**å¸ƒå±€åç§»åˆ†æ•°** çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š

```
å¸ƒå±€åç§»åˆ†æ•° = å½±å“åˆ†æ•° * è·ç¦»åˆ†æ•°
```

å½±å“åˆ†æ•°ï¼šä¸ç¨³å®šå…ƒç´ å¯¹ä¸¤å¸§ä¹‹é—´çš„å¯è§†åŒºåŸŸäº§ç”Ÿçš„å½±å“ï¼Œå‰ä¸€å¸§å’Œå½“å‰å¸§çš„æ‰€æœ‰ä¸ç¨³å®šå…ƒç´ çš„å¯è§åŒºåŸŸé›†åˆï¼ˆå æ€»å¯è§†åŒºåŸŸçš„éƒ¨åˆ†ï¼‰å°±æ˜¯å½“å‰å¸§çš„å½±å“åˆ†æ•°ã€‚

è·ç¦»åˆ†æ•°ï¼šæŒ‡çš„æ˜¯ä»»ä½•ä¸ç¨³å®šå…ƒç´ åœ¨ä¸€å¸§ä¸­ä½ç§»çš„æœ€å¤§è·ç¦»ï¼ˆæ°´å¹³æˆ–å‚ç›´ï¼‰é™¤ä»¥å¯è§†åŒºåŸŸçš„æœ€å¤§å°ºå¯¸ç»´åº¦ï¼ˆå®½åº¦æˆ–é«˜åº¦ï¼Œä»¥è¾ƒå¤§è€…ä¸ºå‡†ï¼‰ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª **ä¼šè¯çª—å£** çš„æ¦‚å¿µï¼šä¸€ä¸ªæˆ–å¤šä¸ªå¿«é€Ÿè¿ç»­å‘ç”Ÿçš„å•æ¬¡å¸ƒå±€åç§»ï¼Œæ¯æ¬¡åç§»ç›¸éš”çš„æ—¶é—´å°‘äº `1` ç§’ï¼Œä¸”æ•´ä¸ªçª—å£çš„æœ€å¤§æŒç»­æ—¶é•¿ä¸º `5` ç§’ã€‚

![ä¼šè¯çª—å£](https://fireli-1256465711.cos.ap-chengdu.myqcloud.com/img/%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7/%E5%B8%83%E5%B1%80%E5%81%8F%E7%A7%BB%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3.png)

`CLS` çš„è®¡ç®—æ–¹å¼é€šå¸¸å–æ‰€æœ‰ä¼šè¯çª—å£ä¸­çš„æœ€å¤§ **å¸ƒå±€åç§»åˆ†æ•°**ã€‚

è®¡ç®—å¦‚ä¸‹ï¼š

```js
let sessionValue = 0;
let sessionEntries = [];
const cls = {
    subType: 'layout-shift',
    name: 'layout-shift',
    type: 'performance',
    value: 0
};

const entryHandler = entries => {
    for (const entry of entries) {
        // Only count layout shifts without recent user input.
        if (!entry.hadRecentInput) {
            const firstSessionEntry = sessionEntries[0];
            const lastSessionEntry = sessionEntries[sessionEntries.length - 1];

            // If the entry occurred less than 1 second after the previous entry and
            // less than 5 seconds after the first entry in the session, include the
            // entry in the current session. Otherwise, start a new session.
            if (
                sessionValue &&
                entry.startTime - lastSessionEntry.startTime < 1000 &&
                entry.startTime - firstSessionEntry.startTime < 5000
            ) {
                sessionValue += entry.value;
                sessionEntries.push(entry);
            } else {
                sessionValue = entry.value;
                sessionEntries = [entry];
            }

            // If the current session value is larger than the current CLS value,
            // update CLS and the entries contributing to it.
            if (sessionValue > cls.value) {
                cls.value = sessionValue;
                cls.entries = sessionEntries;
                cls.startTime = performance.now();
                console.log(cls);
            }
        }
    }
};
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'layout-shift', buffered: true });
```

`CLS` çš„æ”¶é›†æ˜¯ä¾æ®è·¯ç”±çš„ï¼Œç›´åˆ°è·¯ç”±å˜æ›´å‰ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æŒç»­æ”¶é›†å½“å‰é¡µé¢ `CLS`ã€‚

> æ— æ³•é€šè¿‡ `performance.getEntriesByType('layout-shift')` è·å–å¸ƒå±€åç§»åˆ†æ•°ã€‚

å¸ƒå±€åç§»åªæœ‰åœ¨ç”¨æˆ·å¹¶ä¸æœŸæœ›å…¶å‘ç”Ÿæ—¶æ‰ç®—æ˜¯åäº‹ã€‚æ¢è¨€ä¹‹ï¼Œå¯¹ç”¨æˆ·äº¤äº’ï¼ˆå•å‡»é“¾æ¥ã€ç‚¹é€‰æŒ‰é’®ã€åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ä¿¡æ¯ç­‰ï¼‰è¿›è¡Œå“åº”çš„å¸ƒå±€åç§»é€šå¸¸æ²¡æœ‰é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåœ¨ç”¨æˆ·è¾“å…¥ `500` æ¯«ç§’å†…å‘ç”Ÿçš„å¸ƒå±€åç§»ä¼šå¸¦æœ‰ `hadRecentInput` æ ‡å¿—ï¼Œä¾¿äºåœ¨è®¡ç®—ä¸­æ’é™¤è¿™äº›åç§»ã€‚

> `hadRecentInput` æ ‡å¿—ä»…é€‚ç”¨äºä¸è¿ç»­è¾“å…¥äº‹ä»¶ï¼Œå¦‚è½»è§¦ã€ç‚¹å‡»æˆ–æŒ‰é”®æ“ä½œã€‚æ»šåŠ¨ã€æ‹–åŠ¨æˆ–ææ‹‰ç¼©æ”¾æ‰‹åŠ¿ç­‰è¿ç»­æ€§äº¤äº’æ“ä½œä¸ç®—ã€‚

å¦å¤–ï¼Œ**`css transform` å±æ€§èƒ½å¤Ÿåœ¨ä¸è§¦å‘å¸ƒå±€åç§»çš„æƒ…å†µä¸‹ä¸ºå…ƒç´ è®¾ç½®åŠ¨ç”»**ã€‚

æ›´å¤šå†…å®¹æŸ¥çœ‹ï¼š[Cumulative Layout Shift ç´¯ç§¯å¸ƒå±€åç§» (CLS)](https://web.dev/cls/) ã€‚

### TTI

`TTI`(`time-to-interactive`) ï¼Œä»å¼€å§‹åŠ è½½åˆ°ä¸»è¦å­èµ„æºå®Œæˆæ¸²æŸ“ï¼Œå¹¶èƒ½å¤Ÿå¿«é€Ÿã€å¯é åœ°å“åº”ç”¨æˆ·è¾“å…¥æ‰€éœ€çš„æ—¶é—´ã€‚ç½‘ç«™çš„ `TTI` æœ€å¥½æ˜¯ `5` ç§’ä»¥å†…

`TTI` å¯ä»¥è¯´æ˜¯è¡¡é‡ç½‘é¡µä½•æ—¶çœŸæ­£å¯ç”¨çš„é‡è¦æŒ‡æ ‡ã€‚

`TTI` çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š

1. å…ˆè¿›è¡Œé¦–æ¬¡å†…å®¹ç»˜åˆ¶ (`FCP`)ã€‚
2. æ²¿æ—¶é—´è½´æ­£å‘æœç´¢æ—¶é•¿è‡³å°‘ä¸º `5` ç§’çš„å®‰é™çª—å£ï¼Œå…¶ä¸­ï¼Œå®‰é™çª—å£çš„å®šä¹‰ä¸ºï¼šæ²¡æœ‰ [é•¿ä»»åŠ¡](./å‰ç«¯ç›‘æ§#long-task) ä¸”ä¸è¶…è¿‡ä¸¤ä¸ªæ­£åœ¨å¤„ç†çš„ç½‘ç»œ `GET` è¯·æ±‚ã€‚
3. æ²¿æ—¶é—´è½´åå‘æœç´¢å®‰é™çª—å£ä¹‹å‰çš„æœ€åä¸€ä¸ªé•¿ä»»åŠ¡ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°é•¿ä»»åŠ¡ï¼Œåˆ™åœ¨ `FCP` æ­¥éª¤åœæ­¢æ‰§è¡Œã€‚
4. `TTI` æ˜¯å®‰é™çª—å£ä¹‹å‰æœ€åä¸€ä¸ªé•¿ä»»åŠ¡çš„ç»“æŸæ—¶é—´ï¼ˆå¦‚æœæ²¡æœ‰æ‰¾åˆ°é•¿ä»»åŠ¡ï¼Œåˆ™ä¸ `FCP` å€¼ç›¸åŒï¼‰ã€‚

ä¸‹å›¾å°†æœ‰åŠ©äºæ‚¨æ›´ç›´è§‚åœ°ç†è§£ä¸Šè¿°æ­¥éª¤ï¼š

![TTIæ—¶é—´ç‚¹](https://fireli-1256465711.cos.ap-chengdu.myqcloud.com/img/%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7/TTI%20%E6%97%B6%E9%97%B4.png)

ä¹Ÿå¯ä»¥ä½¿ç”¨ [tti-polyfill](https://github.com/GoogleChromeLabs/tti-polyfill) æ¥è·å–ç½‘é¡µçš„ `TTI` ã€‚

### TBT

`TBT`(`total-blocking-time`) ï¼Œ `FCP` å’Œ `TTI` ä¹‹é—´å‘ç”Ÿçš„æ¯ä¸ª [é•¿ä»»åŠ¡](./å‰ç«¯ç›‘æ§#long-task) çš„é˜»å¡æ—¶é—´æ€»å’Œã€‚ `TBT` åº”è¯¥æ§åˆ¶åœ¨ `300ms` ä»¥å†…ã€‚

é•¿ä»»åŠ¡æŒ‡è¶…è¿‡ `50ms` çš„ä»»åŠ¡ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡è¶…è¿‡äº† `50ms` ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡ï¼š`é˜»å¡æ—¶é—´ = ä»»åŠ¡æ—¶é—´ - 50ms` ã€‚

**TBT ä¸ TTI æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ**

`TTI` ä¼šåœ¨ä¸»çº¿ç¨‹è‡³å°‘æœ‰äº”ç§’é’Ÿæ²¡æœ‰é•¿ä»»åŠ¡æ—¶ï¼Œè®¤ä¸ºé¡µé¢å…·å¤‡"å¯é äº¤äº’æ€§"ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†å¸ƒåœ¨ `10` ç§’é’Ÿé‡Œçš„ä¸‰ä¸ª `51` æ¯«ç§’é•¿çš„ä»»åŠ¡ä¸å•ä¸ª `10` ç§’é•¿çš„ä»»åŠ¡å¯¹ `TTI` çš„å½±å“æ˜¯ç›¸åŒçš„ï¼Œä½†å¯¹äºè¯•å›¾ä¸é¡µé¢è¿›è¡Œäº¤äº’çš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™ä¸¤ç§æƒ…å†µç»™äººçš„æ„Ÿè§‰æ˜¯æˆªç„¶ä¸åŒçš„ã€‚

åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œä¸‰ä¸ª `51` æ¯«ç§’çš„ä»»åŠ¡çš„ `TBT` ä¸º `3` æ¯«ç§’ã€‚è€Œå•ä¸ª `10` ç§’é•¿çš„ä»»åŠ¡çš„ TBT ä¸º `9950` æ¯«ç§’ã€‚ç¬¬äºŒç§æƒ…å†µä¸‹è¾ƒå¤§çš„ `TBT` å€¼å¯¹è¾ƒå·®çš„ä½“éªŒè¿›è¡Œäº†é‡åŒ–ã€‚

æ›´å¤šå¯ä»¥æŸ¥çœ‹ï¼š[Total Blocking Time æ€»é˜»å¡æ—¶é—´ (TBT)](https://web.dev/tbt/) ã€‚

### web-vitals

ä½¿ç”¨ `PerformanceObserver` å¹¶ä¸èƒ½å®Œå…¨ä¿è¯è·å–åˆ°å‡†ç¡®çš„æ€§èƒ½æ•°æ®ã€‚

ä¸€èˆ¬æ¥è¯´è¿˜éœ€è¦è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼Œä»¥ `FCP` ä¸ºä¾‹ï¼š

1. `API` ä¼šä¸ºåœ¨åå°é€‰é¡¹å¡ä¸­åŠ è½½çš„é¡µé¢åˆ†å‘ `first-contentful-paint` æ¡ç›®ï¼Œä½†åœ¨è®¡ç®— `FCP` æ—¶åº”å¿½ç•¥è¿™äº›é¡µé¢ï¼ˆåªæœ‰å½“é¡µé¢å§‹ç»ˆå¤„äºå‰å°æ—¶æ‰åº”è€ƒè™‘é¦–æ¬¡ç»˜åˆ¶çš„æ—¶æœºï¼‰ã€‚
2. å½“é¡µé¢é€šè¿‡[å¾€è¿”ç¼“å­˜](https://web.dev/bfcache/#impact-on-core-web-vitals)æ¢å¤æ—¶ï¼Œ `API` ä¸ä¼šæŠ¥å‘Š `first-contentful-paint` æ¡ç›®ï¼Œä½†åœ¨è¿™äº›æƒ…å†µä¸‹åº”è¯¥æµ‹é‡ `FCP` ï¼Œå› ä¸ºè¿™å¯¹ç”¨æˆ·æ¥è¯´æ˜¯å¤šæ¬¡ä¸åŒçš„é¡µé¢è®¿é—®ä½“éªŒã€‚
3. `API` å¯èƒ½ä¸ä¼šæŠ¥å‘Šè·¨åŸŸ `iframe` ä¸­çš„ç»˜åˆ¶æ—¶æœºï¼Œä½†è¦æƒ³æ­£ç¡®æµ‹é‡ `FCP` ï¼Œæ‚¨åº”è¯¥è€ƒè™‘æ‰€æœ‰æ¡†æ¶çš„æƒ…å†µã€‚å­æ¡†æ¶å¯ä»¥ä½¿ç”¨ `API` å°†è¿™äº›æ¡†æ¶çš„ç»˜åˆ¶æ—¶æœºæŠ¥å‘Šç»™çˆ¶æ¡†æ¶æ¥è¿›è¡Œèšåˆã€‚

å…¶ä»–æ€§èƒ½æŒ‡æ ‡éœ€è¦æ³¨æ„çš„ç‚¹å¯ä»¥æŸ¥çœ‹ [ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„æ€§èƒ½æŒ‡æ ‡](https://web.dev/i18n/zh/user-centric-performance-metrics/) ä¸­å…·ä½“çš„è¯´æ˜ã€‚

è¿™é‡Œè¯´ä¸€ä¸‹ `bfcache` å¾€è¿”ç¼“å­˜ï¼šæ˜¯ä¸€ç§å†…å­˜ç¼“å­˜ï¼Œå®ƒä¼šå°†æ•´ä¸ªé¡µé¢ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å½“ç”¨æˆ·è¿”å›æ—¶å¯ä»¥é©¬ä¸Šçœ‹åˆ°æ•´ä¸ªé¡µé¢ï¼Œè€Œä¸ç”¨å†æ¬¡åˆ·æ–°ã€‚ `firfox` å’Œ `safari` ä¸€ç›´æ”¯æŒ `bfc` ï¼Œ `chrome` åªæœ‰åœ¨é«˜ç‰ˆæœ¬çš„ç§»åŠ¨ç«¯æµè§ˆå™¨æ”¯æŒã€‚

å½“é¡µé¢è¿›å‡º `bfcache` ä¼šè§¦å‘ä»¥äº‹ä»¶ï¼š

```js
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        console.log('This page was restored from the bfcache.');
    } else {
        console.log('This page was loaded normally.');
    }
});

window.addEventListener('pagehide', function(event) {
    if (event.persisted === true) {
        console.log('This page *might* be entering the bfcache.');
    } else {
        console.log('This page will unload normally and be discarded.');
    }
});
```

[web-vitals](https://github.com/GoogleChrome/web-vitals) ä¼š **å°½å¯èƒ½** æä¾›å¯¹è¿™äº›æƒ…å†µçš„å¤„ç†ã€‚ç›®å‰æ”¯æŒï¼š `FCP`, `LCP`, `CLS`, `FID`, `TTFB` ã€‚

### longtask

`longtask` ï¼Œä¸»çº¿ç¨‹ä¸­è¶…è¿‡ `50ms` çš„ä»»åŠ¡è¢«ç§°ä¸ºé•¿ä»»åŠ¡ã€‚

```js
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'longtask', buffered: true });
```

> æ— æ³•é€šè¿‡ `performance.getEntriesByType('longtask')` è·å–é•¿ä»»åŠ¡ã€‚

### Element Timing API

`Element Timing API` ï¼Œæµ‹é‡ `dom` å…ƒç´ ç»˜åˆ¶çš„æ—¶é—´ã€‚å…¶æµ‹é‡çš„å…ƒç´ èŒƒå›´å’Œ `LCP` ä¸€æ ·ï¼Œ`LCP` çš„æµ‹é‡ä¹Ÿæ˜¯åŸºäº `Element Timing API`ã€‚

```js
<img elementtiming="hero-image" />
<p elementtiming="important-paragraph">This is text I care about.</p>

// js

const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'element', buffered: true });
```

> æ— æ³•é€šè¿‡ `performance.getEntriesByType('element')` è·å–å…ƒç´ ç»˜åˆ¶æ—¶é—´ã€‚

### Event Timing API

`Event Timing API` ï¼Œæµ‹é‡äº‹ä»¶è§¦å‘çš„æ—¶é—´ã€‚ `FID` çš„æµ‹é‡æ˜¯åŸºäº `Event Timing API` ã€‚

```js
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'event', buffered: true });
```

> æ— æ³•é€šè¿‡ `performance.getEntriesByType('event')` è·å–äº‹ä»¶è§¦å‘æ—¶é—´ã€‚

äº‹ä»¶è§¦å‘æ—¶ï¼Œä¼šæ”¶åˆ°ä»¥ä¸‹å‚æ•°ï¼š

1. `startTime`: æµè§ˆå™¨æ¥æ”¶åˆ°äº‹ä»¶çš„æ—¶é—´ã€‚
2. `processingStart`: æµè§ˆå™¨å¼€å§‹å¤„ç†äº‹ä»¶çš„æ—¶é—´ã€‚ä¼šè¢«å…¶ä»–ä¸»çº¿ç¨‹ä»»åŠ¡é˜»å¡ã€‚
3. `processingEnd`: æµè§ˆå™¨å¤„ç†å®Œæ‰€æœ‰äº‹ä»¶å›è°ƒçš„æ—¶é—´ã€‚
4. `duration`: ä»æµè§ˆå™¨æ¥æ”¶åˆ°äº‹ä»¶ï¼Œä¹‹åå¤„ç†å®Œæ‰€æœ‰äº‹ä»¶å›è°ƒï¼Œåˆ°ä¸‹ä¸€å¸§ï¼ˆå› ä¸ºå®‰å…¨åŸå› ï¼Œå¤§çº¦ `8ms` ï¼‰çš„æ—¶é—´é—´éš”ã€‚

å…·ä½“æ”¯æŒçš„äº‹ä»¶æŸ¥çœ‹ï¼š[MDN PerformanceEventTiming](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceEventTiming)

### Resource Timing API

`Resource Timing API` ï¼Œæ£€ç´¢å’Œåˆ†ææœ‰å…³åŠ è½½åº”ç”¨ç¨‹åºèµ„æºçš„è¯¦ç»†ç½‘ç»œè®¡æ—¶æ•°æ®ã€‚

```js
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'resource', buffered: true });

// æˆ–è€…
performance.getEntriesByType('resource');
```

è·å–åˆ°çš„éƒ¨åˆ†ä¿¡æ¯å¦‚ä¸‹ï¼š

1. `initiatorType`: èµ„æºç±»å‹ï¼Œä¾‹å¦‚ï¼š `dom` å…ƒç´ èŠ‚ç‚¹åï¼Œ `css` ï¼Œ `xmlhttprequest` ç­‰ã€‚
2. `nextHopProtocol`: ç½‘ç»œåè®®, ä¾‹å¦‚ï¼š `h2`, `quic` ã€‚
3. `encodedBodySize/decodedBodySize`: å†…å®¹å¤§å°ã€‚
4. `transferSize`: èµ„æºå¤§å°ï¼ŒåŒ…æ‹¬å“åº”å¤´å­—æ®µå’Œå“åº” `payload` `body` çš„å¤§å°.

æ›´å¤šå­—æ®µæŸ¥çœ‹ï¼š[MDN PerformanceResourceTiming](https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceResourceTiming)

### Navigation Timing API

`Navigation Timing API` ï¼Œæµè§ˆå™¨æ–‡æ¡£èµ„æºåŠ è½½æ—¶çš„è®¡æ—¶æ•°æ®ã€‚å’Œ `Resource Timing API` ç±»ä¼¼ï¼Œä½†å®ƒåŒ…å«æ›´å¤šçš„å­—æ®µï¼Œä¾‹å¦‚ï¼š `DOMContentLoaded` ï¼Œ `load` ï¼Œ `dom` è§£æçš„æ—¶é—´ç­‰ç­‰ã€‚

`performance.timing` å·²ç»åºŸå¼ƒï¼Œ`Navigation Timing API` æ˜¯ `performance.timing` çš„æ›¿æ¢ã€‚

```js
const observer = new PerformanceObserver(entryHandler);
observer.observe({ type: 'navigation', buffered: true });

// æˆ–è€…
performance.getEntriesByType('navigation');
```

è·å–åˆ°çš„å­—æ®µå¯ä»¥æŸ¥çœ‹è¿™é‡Œï¼š

1. [MDN PerformanceNavigationTiming](https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceNavigationTiming)
2. [åº”ç”¨ï¼šå‰ç«¯æ€§èƒ½ç›‘æ§ performance](https://juejin.cn/post/6844903926496493581)

![](https://fireli-1256465711.cos.ap-chengdu.myqcloud.com/img/%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7/PerformanceNavigationTiming.png)

#### èµ„æºåŠ è½½æ—¶é—´

ä»è¿™äº›å­—æ®µä¸­ï¼Œå¯ä»¥è·å–åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š

```js
let entry = performance.getEntriesByType('navigation');
const record = {};

// é‡å®šå‘æ—¶é—´
record.redirectDuration = entry.redirectEnd - entry.redirectStart;

// DNS æŸ¥è¯¢æ—¶é—´
record.domainLookupDuration = entry.domainLookupEnd - entry.domainLookupStart;

// TCP, HTTPè¿æ¥è€—æ—¶
record.connectDuration = entry.connectEnd - entry.connectStart;

// SSL è¿æ¥è€—æ—¶
record.SSLConnectDuration = entry.connectEnd - entry.secureConnectionStart;

// é¦–å­—èŠ‚æ—¶é—´
record.TTFB = entry.responseStart;

// æ•°æ®ä¼ è¾“æ—¶é—´
record.responseDuration = entry.responseEnd - entry.responseStart;

// æ•°æ®ä¼ è¾“å®Œæˆæ—¶é—´
record.dataCompleted = entry.responseEnd - entry.fetchStart;

// http å¤´éƒ¨å¤§å°
record.httpHeaderSize = entry.transferSize - entry.encodedBodySize;

// èµ„æºå¤§å°
record.httpResourceSize = entry.encodedBodySize;

// å¸è½½é¡µé¢çš„æ—¶é—´
record.prePageUnloadEvent = entry.unloadEventEnd - entry.unloadEventStart;

// é‡å®šå‘æ¬¡æ•°
record.redirectCount = entry.redirectCount;

// dom è§£ææ—¶é—´
record.domParseDuration = entry.domInteractive - entry.responseEnd;

// DomContentLoaded äº‹ä»¶ååˆ°è§¦å‘ load äº‹ä»¶é—´çš„èµ„æºåŠ è½½æ—¶é—´
record.resourceLoadDurationAfterDomContentLoaded = entry.loadEventStart - entry.domContentLoadedEventEnd;

// å¯äº¤äº’æ—¶é—´
record.TTI = entry.domInteractive - entry.fetchStart;

// dom è§£ææ¸²æŸ“å®Œæ¯•æ—¶é—´
record.domReady = entry.domContentLoadedEventEnd - entry.fetchStart;

// é¡µé¢åŠ è½½å®Œæˆçš„æ—¶é—´
record.pageLoaded = entry.loadEventStart - entry.fetchStart;

// æ‰§è¡Œ onload å›è°ƒå‡½æ•°çš„æ—¶é—´
record.loadEvent = entry.loadEventEnd - entry.loadEventStart;
```

å…¶ä¸­çš„ä¸€äº›æŒ‡æ ‡å¯ä»¥å½“åšå‚è€ƒã€‚

#### ç¼“å­˜å‘½ä¸­

`transferSize` å­—æ®µï¼šè¡¨ç¤ºè·å–èµ„æºçš„å¤§å°ï¼ŒåŒ…æ‹¬å“åº”å¤´å­—æ®µå’Œå“åº”æ•°æ®çš„å¤§å°ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸º `0` ï¼Œè¯´æ˜æ˜¯ä»å¼ºç¼“å­˜ä¸­ç›´æ¥è¯»å–çš„ï¼›å¦‚æœè¿™ä¸ªå€¼ä¸ä¸º `0` ï¼Œä½†æ˜¯ `encodedBodySize` ï¼ˆ `encodedBodySize` è¡¨ç¤ºè¯·æ±‚å“åº”æ•°æ® `body` çš„å¤§å°ï¼‰å­—æ®µä¸º `0` ï¼Œè¯´æ˜ä½¿ç”¨çš„æ˜¯åå•†ç¼“å­˜ã€‚

```js
function checkFromCache(entry) {
    // å¼ºç¼“å­˜
    if (entry.transferSize === 0) {
        return 'strong_cache';
    }

    // åå•†ç¼“å­˜
    if (entry.transferSize !== 0 && entry.encodedBodySize === 0) {
        return 'negotiation_cache';
    }

    return 'none';
}
```

### entryType

åœ¨ä¸Šé¢åŸºæœ¬éƒ½æ˜¯æ”¹å˜ [type](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceEntry/entryType) æ¥è§‚å¯Ÿä¸åŒçš„æ€§èƒ½æ•°æ®ï¼š

```js
observer.observe({ type: 'paint', buffered: true });
observer.observe({ type: 'resource', buffered: true });
```

ä¸Šé¢å·²ç»ä»‹ç»å®Œå…¨éƒ¨çš„ `type` ç±»å‹ï¼Œå®Œæ•´ `type` åˆ—è¡¨å¯ä»¥æŸ¥çœ‹[è¿™é‡Œ](https://w3c.github.io/timing-entrytypes-registry/#registry)ã€‚

### Server Timing API

`Server Timing API` ï¼Œè·å–æœåŠ¡ç«¯å¤„ç†ç›¸å…³æ—¶é—´ï¼Œä¾‹å¦‚ï¼šæ•°æ®åº“æŸ¥è¯¢ç­‰ã€‚å…¶ä¾èµ–äº `http` å“åº”å¤´éƒ¨çš„ `Server-Timing` å­—æ®µï¼Œä¾‹å¦‚ï¼š

```
HTTP/1.1 200 OK

Server-Timing: inner; dur=77, pp;dur=34, total;dur=70;desc="Nuxt Server Time"
```

åœ¨ `Resource Timing API` å’Œ `Navigation Timing API` è·å–çš„èµ„æºåŠ è½½ä¿¡æ¯ä¸­å­˜æœ‰ `serverTiming` å­—æ®µï¼š

```js
performance.getEntriesByType('navigation')[0].serverTiming;
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```js
[
    {
        name: 'inner',
        duration: 77,
        description: ''
    },
    {
        name: 'pp',
        duration: 34,
        description: ''
    },
    {
        name: 'total',
        duration: 70,
        description: 'Nuxt Server Time'
    }
];
```

### User Timing API

`User Timing API` ï¼Œç”¨æˆ·è‡ªå®šä¹‰è®¡æ—¶æ¥å£ã€‚ç”¨äºåœ¨ä»»ä½•åœ°æ–¹æ ‡è®°ï¼Œç„¶åå¯ä»¥æµ‹é‡å‡ºè¿™äº›æ ‡è®°ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚

```js
// Record the time immediately before running a task.
performance.mark('myTask:start');
await doMyTask();
// Record the time immediately after running a task.
performance.mark('myTask:end');

// Measure the delta between the start and end of the task
performance.measure('myTask', 'myTask:start', 'myTask:end');
```

ä½¿ç”¨ `mark` æˆ–è€… `measure` ï¼Œå…¶å®æ˜¯åˆ›å»ºä¸€ä¸ªæ—¶é—´æˆ³ï¼ˆ `DOMHighResTimeStamp` ï¼‰å­˜å…¥èµ„æºç¼“å­˜æ•°æ®ä¸­ã€‚

åç»­å¯ä»¥é€šè¿‡ `getEntriesByName`, `getEntriesByType`, `getEntries` è·å–è¿™äº›ç¼“å­˜æ•°æ®ã€‚

```js
performance.getEntriesByName('myTask', 'measure');
performance.getEntriesByName('myTask:start', 'mark');
performance.getEntriesByName('myTask:end', 'mark');
```

ä»¥ `performance.getEntriesByName('myTask', 'measure')` ä¸ºä¾‹ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```json
[
    {
        "name": "myTask",
        "entryType": "measure",
        "startTime": 817501.400000006,
        "duration": 0.19999998807907104
    }
]
```

æ›´å¤šæ¥å£è¯´æ˜å¯ä»¥æŸ¥çœ‹ï¼š

1. [MDN Performance](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance)
2. [ä½ æ˜¯å¦çœŸçš„æ‡‚ H5 performance å±æ€§](https://juejin.cn/post/7011427082307633165)

### é¦–å±æ—¶é—´

é¦–å±æ—¶é—´ï¼Œé¦–å±ç»˜åˆ¶å®Œæˆçš„æ—¶é—´ï¼Œä»£è¡¨é¡µé¢å·²ç»åŸºæœ¬å‘ˆç°åœ¨ç”¨æˆ·çœ¼å‰ã€‚

å¦‚æœæƒ³è·å–é¦–å±å®Œå…¨æ¸²æŸ“å®Œæˆçš„æ—¶é—´å¯ä»¥è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

1. ä½¿ç”¨ [MutationObserver](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver/MutationObserver) ç›‘å¬ `document` å¯¹è±¡ï¼Œæ¯å½“æœ‰å­èŠ‚ç‚¹æ·»åŠ è¿›æ–‡æ¡£æ—¶ä¼šè§¦å‘äº‹ä»¶ã€‚
2. ä½¿ç”¨ [IntersectionObserver](https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver/IntersectionObserver) è§‚å¯Ÿæ¯ä¸ªå­èŠ‚ç‚¹æ˜¯å¦æ¸²æŸ“åœ¨å¯è§†çª—å£ï¼Œè·å–åˆ°**æœ€åä¸€ä¸ªå­èŠ‚ç‚¹æ¸²æŸ“åœ¨å¯è§†çª—å£çš„æ—¶é—´**ã€‚`IntersectionObserver` æ¥å£ä¼šåœ¨æ¯æ¬¡èŠ‚ç‚¹å‡ºç°åœ¨å¯è§†çª—å£æ—¶ï¼Œè§¦å‘ä¸€æ¬¡å›è°ƒã€‚
3. `onLoad` åä½¿ç”¨ `performance.getEntriesByType('resource')` è·å–**æœ€åä¸€å¼ å›¾ç‰‡åŠ è½½å®Œæˆçš„æ—¶é—´**ã€‚é¦–å±æ—¶é—´ä¸º **æœ€åä¸€ä¸ªå­èŠ‚ç‚¹æ¸²æŸ“åœ¨å¯è§†çª—å£çš„æ—¶é—´** å’Œ **æœ€åä¸€å¼ å›¾ç‰‡åŠ è½½å®Œæˆçš„æ—¶é—´** ä¹‹é—´çš„æœ€å¤§å€¼ã€‚

> ä¸Šé¢çš„æ­¥éª¤æ²¡æœ‰è€ƒè™‘æ»šåŠ¨çš„æƒ…å†µï¼Œæ›´å…·ä½“çš„æ–¹å¼å¯ä»¥æŸ¥çœ‹ [å¦‚ä½•ç»Ÿè®¡é¦–å±æ¸²æŸ“æ—¶é—´](https://juejin.cn/post/6962742206692065287) ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ [MutationObserver](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver/MutationObserver) è·å–åˆ° **`dom` èŠ‚ç‚¹å˜åŒ–æœ€å¤§** çš„æ—¶é—´ç‚¹ä½œä¸ºé¦–å±æ—¶é—´ã€‚åŸç†æŸ¥çœ‹ [è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/7035647196510814221) ã€‚

### FMP

`FMP`(`first-meaningful-paint`)ï¼Œé¦–æ¬¡æœ‰æ•ˆç»˜åˆ¶ï¼Œè¡¨ç¤ºé¡µé¢çš„ä¸»è¦å†…å®¹æ¸²æŸ“å®Œæ¯•ã€‚

[FMP](https://web.dev/first-meaningful-paint/) åœ¨ `Lighthouse` ä¸­å·²ç»è¢«åºŸå¼ƒï¼Œå› ä¸ºå®ƒä¾èµ–äºæµè§ˆå™¨çš„å®ç°ç»†èŠ‚ï¼Œæ— æ³•è¢«æ ‡å‡†åŒ–ã€‚

ä½†æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸»è¦å†…å®¹åœ¨ä½•æ—¶è¢«æ¸²æŸ“ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š

1. è‡ªå®šä¹‰æ‰“ç‚¹ã€‚æŸä¸€å¼ å›¾ç‰‡æ¸²æŸ“å®Œæˆï¼ŒæŸä¸€æ¥å£è¯·æ±‚å®Œæˆç­‰ç­‰ã€‚
2. ç±»ä¼¼äºé¦–å±è®¡ç®—çš„æ–¹å¼ï¼Œåˆ©ç”¨ `Mutation Observer API` ç›‘å¬ä¸»è¦å†…å®¹å®¹å™¨ï¼ˆä¾‹å¦‚ï¼š `div` ï¼‰é«˜åº¦æ˜¯å¦å¤§äºæŒ‡å®šå€¼ï¼Œå¦‚æœå¤§äºäº†ï¼Œå°±è¡¨ç¤ºä¸»è¦å†…å®¹å·²ç»æ¸²æŸ“å‡ºæ¥ã€‚
3. åˆ©ç”¨ `FCP` æ¥æ›¿ä»£ `FMP` ï¼Œè¿™ä¹Ÿæ˜¯å®˜æ–¹æ¨èçš„åšæ³•ã€‚

### å•é¡µé¢

æ€§èƒ½ç›‘æ§ä¸€èˆ¬ä»¥é¡µé¢ä¸ºå•ä½ï¼Œå½“è·¯ç”±å˜åŒ–æ—¶ï¼Œéœ€è¦é‡æ–°æ”¶é›†ä¸Šé¢çš„ä¿¡æ¯ã€‚

è€Œå¯¹äºå•é¡µé¢æ¥è¯´ï¼Œè·¯ç”±å˜åŒ–åªæ˜¯é€šè¿‡ `js` é‡æ–°åœ¨å®¹å™¨å†…éƒ¨å†™å…¥æ–°çš„å†…å®¹ï¼Œä¸€äº›æ€§èƒ½æ•°æ®æ— æ³•æ”¶é›†ï¼š `FP`, `FCP`, `LCP`, `FID`, `TTI`, `TBT` ç­‰ã€‚

è¿™æ—¶ï¼Œè¦å€ŸåŠ©æ¡†æ¶æœ¬èº«ï¼ˆ `vue`, `react` ç­‰ï¼‰å»æ”¶é›†ç±»ä¼¼æ•°æ®ã€‚

## é”™è¯¯ç›‘æ§

### èµ„æºåŠ è½½é”™è¯¯å’Œ JS é”™è¯¯

`window` ç›‘å¬ `error` äº‹ä»¶å¯ä»¥æ•æ‰åˆ°èµ„æºåŠ è½½é”™è¯¯å’Œ `js` é”™è¯¯ï¼š

```js
window.addEventListener(
    'error',
    e => {
        // JS é”™è¯¯
        if (e instanceof ErrorEvent) {
            const { message, lineno, colno, error, timeStamp } = e;
            const errorInfo = {
                message,
                line: lineno,
                column: colno,
                stack: error.stack,
                subType: 'js',
                type: 'error',
                startTime: timeStamp
            };

            console.log(errorInfo);
        }

        const target = e.target;

        // èµ„æºåŠ è½½é”™è¯¯
        if (target && (target.src || target.href)) {
            const url = target.src || target.href;
            const errorInfo = {
                url,
                type: 'error',
                subType: 'resource',
                startTime: e.timeStamp,
                html: target.outerHTML,
                resourceType: target.tagName,
                paths: e.path.map(item => item.tagName).filter(Boolean)
            };

            console.log(errorInfo);
        }
    },
    true
);
```

### promise é”™è¯¯

`window.addEventListener('error')` ä¸èƒ½æ•æ‰åˆ° `promise` é”™è¯¯ï¼Œå¯¹äº `promise` é”™è¯¯éœ€è¦ç›‘å¬ `unhandledrejection` äº‹ä»¶ï¼š

```js
window.addEventListener('unhandledrejection', e => {
    const errorInfo = {
        reason: e.reason?.stack,
        subType: 'promise',
        type: 'error',
        startTime: e.timeStamp
    };

    console.log(errorInfo);
});
```

### æ¡†æ¶å±‚é”™è¯¯

`Vue` ä½¿ç”¨ `Vue.config.errorHandler` ï¼Œ `React` ä½¿ç”¨ `componentDidCatch` ã€‚

### æ¥å£é”™è¯¯

è§ä¸‹æ–¹çš„ [è¯·æ±‚ä¸ŠæŠ¥](./å‰ç«¯ç›‘æ§å°ç»“.md#è¯·æ±‚ä¸ŠæŠ¥) ã€‚

### console.error

ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼Œä¼šå°†ä¸€äº›æ¯”è¾ƒä¸¥é‡çš„å¼‚å¸¸é€šè¿‡ `console.error` æ‰“å°å‡ºæ¥ï¼Œå¯¹äºè¿™äº›å¼‚å¸¸ä¹Ÿå¯ä»¥æ”¶é›†å¸®åŠ©å®šä½é—®é¢˜ã€‚æ”¶é›†æ–¹æ³•æ˜¯é‡å†™ `console.error` æ–¹æ³•ã€‚

### è·¨åŸŸ script æ ‡ç­¾

å¯¹äº `scrpit` æ ‡ç­¾å¼•ç”¨è·¨åŸŸ `js` èµ„æºï¼Œä½¿ç”¨ `window.addEventListener('error')` æ•æ‰åˆ°çš„ `js` é”™è¯¯åªä¼šåé¦ˆå°‘é‡ä¿¡æ¯ï¼š

```
 ["Script error.", "", 0, 0, null]
```

### window.onerror å’Œ window.addEventListener('error')

å¯¹äº `js` é”™è¯¯æ•æ‰ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `window.onerror = function(){}` çš„æ–¹å¼ï¼Œä»–ä»¬çš„åŒºåˆ«åœ¨äºï¼š

#### window.onerror

1. åªèƒ½æ•è·åˆ° `js` æ‰§è¡Œé”™è¯¯ï¼Œä¸èƒ½æ•è·å¸¦æœ‰ `src` çš„æ ‡ç­¾å…ƒç´ çš„åŠ è½½é”™è¯¯ã€‚
2. å‚æ•°å¯¹åº” `5` ä¸ªå€¼ï¼ˆé”™è¯¯ä¿¡æ¯ï¼Œæ‰€åœ¨æ–‡ä»¶ï¼Œè¡Œï¼Œåˆ—ï¼Œé”™è¯¯ä¿¡æ¯ï¼‰
3. ä½¿ç”¨ `return true` å¯ä»¥ä¸è®©å¼‚å¸¸ä¿¡æ¯è¾“å‡ºåˆ°æ§åˆ¶å°

#### window.addEventListener('error')

1. ä¸ºæ•è·çŠ¶æ€æ—¶ï¼ˆç¬¬ä¸‰ä¸ªå‚æ•°ä¸º `true` ï¼‰èƒ½æ•è·åˆ° `js` æ‰§è¡Œé”™è¯¯ï¼Œä¹Ÿèƒ½æ•è·å¸¦æœ‰ `src` çš„æ ‡ç­¾å…ƒç´ çš„åŠ è½½é”™è¯¯ã€‚
   ä¸ºå†’æ³¡çŠ¶æ€æ—¶ï¼ˆç¬¬ä¸‰ä¸ªå‚æ•°ä¸º `false` ï¼‰èƒ½æ•è·åˆ° `js` æ‰§è¡Œé”™è¯¯ï¼Œä¸èƒ½æ•è·å¸¦æœ‰ `src` çš„æ ‡ç­¾å…ƒç´ çš„åŠ è½½é”™è¯¯ã€‚
2. å‚æ•°å¯¹åº” `1` ä¸ªå€¼ï¼Œå¼‚å¸¸äº‹ä»¶ï¼Œé”™è¯¯ä¿¡æ¯éƒ½åœ¨é‡Œé¢
3. ä½¿ç”¨ `preventDefault` å¯ä»¥ä¸è®©å¼‚å¸¸ä¿¡æ¯è¾“å‡ºåˆ°æ§åˆ¶å°

æ­¤æ—¶éœ€è¦ç»™ `scrpit` æ ‡ç­¾æ·»åŠ  `crossorigin` å±æ€§ï¼Œä¸”æœåŠ¡å™¨ç«¯è®¾ç½® [Access-Control-Allow-Origin](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin) å“åº”å¤´ã€‚

### sourceMap å¤„ç†

ç”Ÿæˆç¯å¢ƒéƒ¨ç½²çš„ä»£ç ä¸€èˆ¬ä¼šç»è¿‡å‹ç¼©è½¬ç ç­‰ï¼Œè¿™æ—¶éœ€è¦ç”Ÿæˆ `sourceMap` ï¼Œå¹¶å°† `sourceMap` å­˜å‚¨åˆ°ä¸€ä¸ªå†…éƒ¨æœåŠ¡å™¨ä¸Šã€‚

å½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ `sourceMap` å¯¹åº”åˆ°æºæ–‡ä»¶çš„ä½ç½®å’Œå˜é‡åä¿¡æ¯ã€‚

æœ‰å…³ `sourceMap` çš„å†…å®¹å¯ä»¥æŸ¥çœ‹ [js ç”Ÿæˆ sourceMap çš„ä¸€äº›äº‹](./js%20ç”Ÿæˆ%20sourceMap%20çš„ä¸€äº›äº‹)

### å¾—åˆ°ä»€ä¹ˆ

ä»ä¸ŠæŠ¥çš„é”™è¯¯ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥éœ€è¦åˆ†æå‡ºä»¥ä¸‹å†…å®¹ï¼š

-   Whatï¼Œå‘â½£äº†ä»€ä¹ˆé”™è¯¯ï¼šé€»è¾‘é”™è¯¯ã€æ•°æ®é”™è¯¯ã€â½¹ç»œé”™è¯¯ã€è¯­æ³•é”™è¯¯ç­‰ã€‚
-   Whenï¼Œå‡ºç°çš„æ—¶é—´æ®µï¼Œå¦‚æ—¶é—´æˆ³ã€‚
-   Whoï¼Œå½±å“äº†å¤šå°‘ç”¨æˆ·ï¼ŒåŒ…æ‹¬æŠ¥é”™äº‹ä»¶æ•°ã€IPã€è®¾å¤‡ä¿¡æ¯ã€‚
-   Whereï¼Œå‡ºç°çš„é¡µé¢æ˜¯å“ªäº›ï¼ŒåŒ…æ‹¬é¡µé¢ã€å¹¿å‘Šä½ã€åª’ä½“ã€‚
-   Whyï¼Œé”™è¯¯çš„åŸå› æ˜¯ä¸ºä»€ä¹ˆï¼ŒåŒ…æ‹¬é”™è¯¯å †æ ˆã€â¾åˆ—ã€ `SourceMap` ã€‚
-   Howï¼Œæ€ä¹ˆå®šä½è§£å†³é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ”¶é›†ç³»ç»Ÿç­‰ä¿¡æ¯ã€‚

## è¡Œä¸ºæ•°æ®

### PV, UV

`PV` æ˜¯é¡µé¢æµè§ˆé‡ï¼Œ `UV` ç”¨æˆ·è®¿é—®é‡ã€‚ `PV` åªè¦è®¿é—®ä¸€æ¬¡é¡µé¢å°±ç®—ä¸€æ¬¡ï¼Œ `UV` åŒä¸€å¤©å†…å¤šæ¬¡è®¿é—®åªç®—ä¸€æ¬¡ã€‚

`PV` å¯ä»¥ç”±å‰ç«¯ä¸ŠæŠ¥ï¼šé¡µé¢æ¯æ¬¡è¿›å…¥æ—¶ï¼Œä¸ŠæŠ¥è¿›å…¥æ—¶é—´ã€‚

`UV` éœ€è¦æœåŠ¡ç«¯æ¥åˆ†æä¸ŠæŠ¥æ•°æ®å¾—å‡ºã€‚

### é¡µé¢åœç•™æ—¶é—´

å¯¹äºéå•é¡µé¢æ¥è¯´ï¼Œé¡µé¢åœç•™æ—¶é—´é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¡ç®—ï¼š

```
é¡µé¢åœç•™æ—¶é—´ = é¡µé¢ unload æ—¶é—´ - é¡µé¢è¿›å…¥æ—¶é—´
```

é¡µé¢è¿›å…¥æ—¶é—´ï¼šå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è·å–ï¼Œä¾‹å¦‚ `Navigation Timing API` ï¼Œ `header` ä¸­ç¬¬ä¸€ä¸ª `js` æ‰§è¡Œæ—¶é—´ç­‰ã€‚

è€Œå•é¡µé¢åˆ™éœ€è¦å€ŸåŠ©æ¡†æ¶æä¾›çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚ `vue` çš„ `destroyed - created`ã€‚

### ç‚¹å‡»äº‹ä»¶

ä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶æœ‰åŠ©äºå‡ºç°é—®é¢˜æ—¶åˆ†æç”¨æˆ·æ“ä½œè½¨è¿¹ã€‚

é€šè¿‡äº‹ä»¶å§”æ‰˜çš„æ–¹å¼åœ¨ `window` å¯¹è±¡ä¸Šä»£ç†ç‚¹å‡»äº‹ä»¶ï¼š

```js
['click', 'touchstart'].forEach(eventType => {
    let timer;
    window.addEventListener(eventType, event => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            const target = event.target;
            // è·å…ƒç´ çš„ä½ç½®ä¿¡æ¯
            const { top, left } = target.getBoundingClientRect();

            console.log({
                top,
                left,
                eventType,
                pageHeight: document.documentElement.scrollHeight || document.body.scrollHeight,
                scrollTop: document.documentElement.scrollTop || document.body.scrollTop,
                type: 'behavior',
                subType: 'click',
                target: target.tagName,
                paths: event.path?.map(item => item.tagName).filter(Boolean),
                startTime: event.timeStamp,
                // è¿™ä¸¤ä¸ªå­—æ®µå¯èƒ½ä¼šå¾ˆé•¿
                outerHTML: target.outerHTML,
                innerHTML: target.innerHTML,
                width: target.offsetWidth,
                height: target.offsetHeight,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                }
            });
        }, 500);
    });
});
```

è¿™ç§æ–¹å¼å¯èƒ½ä¼šè®°å½•å¾ˆå¤šæ— ç”¨çš„ç‚¹å‡»ä¿¡æ¯ã€‚ä¹Ÿæ— æ³•è®°å½•éå†’æ³¡çš„ç‚¹å‡»äº‹ä»¶ã€‚

å¦ä¸€ä¸ªæ–¹æ¡ˆæ˜¯é‡å†™ `addEventListener` æ–¹æ³•ã€‚

> ä¸Šé¢è·å–äº†å…ƒç´ çš„ä½ç½®ä¿¡æ¯å’Œå®½é«˜ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è·å–è¿™äº›ä¿¡æ¯ä¼šå¯¼è‡´é¡µé¢å¼ºåˆ¶é‡ç»˜ã€‚

### è·¯ç”±è·³è½¬

éå•é¡µé¢ï¼Œè·¯ç”±è·³è½¬ç­‰äºï¼šè®°å½•å‰ä¸€ä¸ªé¡µé¢çš„ `unload` äº‹ä»¶ï¼Œæ–°é¡µé¢çš„è¿›å…¥äº‹ä»¶ï¼ˆ `header` ä¸­ç¬¬ä¸€ä¸ª `js` æ‰§è¡Œï¼‰ã€‚

å¯¹äºå•é¡µé¢ï¼Œè·¯ç”±åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š

1. `history` æ¨¡å¼
2. `hash` æ¨¡å¼

```js
let from = '';
window.addEventListener(
    'popstate',
    () => {
        const to = location.href;

        console.log({
            from,
            to,
            type: 'behavior',
            subType: 'popstate',
            startTime: performance.now()
        });

        from = to;
    },
    true
);
```

`history.pushState()` å’Œ `history.replaceState()` ä¸ä¼šè§¦å‘ `popstate` äº‹ä»¶ã€‚ `popstate` äº‹ä»¶ä¼šåœ¨ä»¥ä¸‹æƒ…æ™¯è§¦å‘ï¼š

1. ç‚¹å‡»åé€€ã€å‰è¿›æŒ‰é’®ã€‚
2. `history.back()`, `history.forward()`, `history.go()` æˆ–æ˜¯ `hash` æ”¹å˜ã€‚

å¯¹äº `pushState` å’Œ `replaceState` çš„å¼•å‘çš„è·¯ç”±æ”¹å˜ç›‘å¬ï¼Œå¯ä»¥é€šè¿‡é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•å®ç°ã€‚

```js
let oldURL = '';
window.addEventListener(
    'hashchange',
    event => {
        const newURL = event.newURL;

        console.log({
            from: oldURL,
            to: newURL,
            type: 'behavior',
            subType: 'hashchange',
            startTime: performance.now()
        });

        oldURL = newURL;
    },
    true
);
```

`hashchange` äº‹ä»¶åœ¨ `hash` å˜åŒ–æ—¶è§¦å‘ã€‚

å¯¹äº `vue` å’Œ `react` è¿™äº›æ¡†æ¶æ¥è¯´ï¼Œæœ¬èº«å°±ä¼šæä¾›è·¯ç”±å˜åŒ–çš„äº‹ä»¶ï¼Œç›´æ¥ç›‘å¬è¿™äº›äº‹ä»¶å³å¯ã€‚

### é¡µé¢è®¿é—®æ·±åº¦

è®°å½•é¡µé¢è®¿é—®æ·±åº¦æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä¾‹å¦‚ä¸åŒçš„æ´»åŠ¨é¡µé¢ `a` å’Œ `b` ã€‚ `a` å¹³å‡è®¿é—®æ·±åº¦åªæœ‰ `50%` ï¼Œ `b` å¹³å‡è®¿é—®æ·±åº¦æœ‰ `80%` ï¼Œè¯´æ˜ `b` æ›´å—ç”¨æˆ·å–œæ¬¢ï¼Œæ ¹æ®è¿™ä¸€ç‚¹å¯ä»¥æœ‰é’ˆå¯¹æ€§çš„ä¿®æ”¹ `a` æ´»åŠ¨é¡µé¢ã€‚

é™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥åˆ©ç”¨è®¿é—®æ·±åº¦ä»¥åŠåœç•™æ—¶é•¿æ¥é‰´åˆ«ç”µå•†åˆ·å•ã€‚ä¾‹å¦‚æœ‰äººè¿›æ¥é¡µé¢åä¸€ä¸‹å°±æŠŠé¡µé¢æ‹‰åˆ°åº•éƒ¨ç„¶åç­‰å¾…ä¸€æ®µæ—¶é—´åè´­ä¹°ï¼Œæœ‰äººæ˜¯æ…¢æ…¢çš„å¾€ä¸‹æ»šåŠ¨é¡µé¢ï¼Œæœ€åå†è´­ä¹°ã€‚è™½ç„¶ä»–ä»¬åœ¨é¡µé¢çš„åœç•™æ—¶é—´ä¸€æ ·ï¼Œä½†æ˜æ˜¾ç¬¬ä¸€ä¸ªäººæ›´åƒæ˜¯åˆ·å•çš„ã€‚

æ–¹æ³•å¾ˆç®€å•ï¼Œè®°å½• `scrollTop` ã€é¡µé¢å¯è§†é«˜åº¦ã€é¡µé¢æ€»é«˜åº¦ï¼Œå³å¯å¾—åˆ°ï¼š

```
pageAccessDepth = ( scrollTop + é¡µé¢å¯è§†é«˜åº¦ ) / é¡µé¢æ€»é«˜åº¦
```

```js
é¡µé¢å¯è§†é«˜åº¦ = window.innerHeight;
é¡µé¢æ€»é«˜åº¦ = document.documentElement.scrollHeight;
```

### è¯·æ±‚ä¸ŠæŠ¥

åœ¨è¯·æ±‚å’Œå“åº”æ‹¦æˆªå™¨ä¸­ï¼Œä¸ŠæŠ¥è¯·æ±‚çš„å‘èµ·å’Œå“åº”ä¿¡æ¯ã€‚ä»¥ `axios` ä¸ºä¾‹ï¼š

```js
// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(
    function(config) {
        console.log(config);
        return config;
    },
    function(error) {
        console.log(error);
        return Promise.reject(error);
    }
);

// å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
    function(response) {
        let {
            // è¯·æ±‚æ—¶çš„é…ç½®ä¿¡æ¯
            config,
            data
        } = response;
        console.log(response);
    },
    function(error) {
        const res = error.response;
        console.log(error);
        return Promise.reject(error);
    }
);
```

å¦‚æœæƒ³è¦æ›´é€šç”¨ç‚¹ï¼Œéœ€è¦ç›´æ¥é‡å†™ `xhr` , `fetch` æ‹¿åˆ°è¯·æ±‚å“åº”çš„ç›¸å…³ä¿¡æ¯ã€‚

### ä¸šåŠ¡è‡ªå®šä¹‰åŸ‹ç‚¹ä¸ŠæŠ¥

æ¯”å¦‚ç‚¹äº†æŸä¸ªæŒ‰é’®ï¼Œè§¦å‘äº†ä»€ä¹ˆäº‹ä»¶ï¼Œç”¨æˆ·çŠ¶æ€æ”¹å˜ï¼Œæ¥å£è¯·æ±‚å‘èµ·ç­‰ç­‰ã€‚

## æ•°æ®ä¸ŠæŠ¥

### ä¸ŠæŠ¥æ—¶æœº

ä¸ŠæŠ¥æ—¶æœºæœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. `load` äº‹ä»¶ä¸­ä¸ŠæŠ¥ï¼Œä¸€èˆ¬ç”¨äºä¸€äº› **å¯åŠ¨æ€§èƒ½æ•°æ®** çš„ä¸ŠæŠ¥
2. åœ¨ `beforeunload` å›è°ƒå‡½æ•°é‡Œä¸ŠæŠ¥ã€‚
3. é‡‡ç”¨ `requestIdleCallback/setTimeout` åœ¨ä¸å½±å“ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹å»¶æ—¶ä¸ŠæŠ¥ã€‚
4. ç¼“å­˜ä¸ŠæŠ¥æ•°æ®ï¼Œè¾¾åˆ°ä¸€å®šæ•°é‡åå†ä¸ŠæŠ¥ã€‚

ä¸€èˆ¬çš„ç­–ç•¥å¦‚ä¸‹ï¼š

1. å¯¹äº **å¯åŠ¨æ€§èƒ½æ•°æ®** ï¼Œå¯åœ¨ `load` äº‹ä»¶ä¸­å»¶æ—¶ä¸ŠæŠ¥ã€‚
2. å…¶ä»–è¡Œä¸ºæ•°æ®æˆ–æ˜¯é”™è¯¯æ•°æ®ï¼Œå¯ç¼“å­˜ä¸ŠæŠ¥æ•°æ®ï¼Œç¼“å­˜åˆ°ä¸€å®šæ•°é‡åï¼Œå»¶æ—¶ä¸ŠæŠ¥ã€‚
3. æœ€ååœ¨ `beforeunload` ä¸­ä¸ŠæŠ¥å‰©ä½™éƒ¨åˆ†æ•°æ®ã€‚

### ä¸ŠæŠ¥æ–¹æ³•

ä¸ŠæŠ¥æ–¹æ³•ç”±ä»¥ä¸‹å‡ ç§ï¼š

1. [sendBeacon](https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon)
2. XMLHttpRequest
3. image

ä¸€èˆ¬æ¥è¯´åœ¨ `beforeunload` ä¸­ä¸ŠæŠ¥æ—¶ï¼Œéœ€è¦ä½¿ç”¨åŒæ­¥çš„ `XMLHttpRequest` ï¼Œå¦‚æœæ˜¯å¼‚æ­¥ï¼Œé‚£è¿™ä¸ªè¯·æ±‚å¯èƒ½ä¼šè¢«æµè§ˆå™¨ `cancel` æ‰ã€‚

å¦‚æœè¦ä½¿ç”¨å¼‚æ­¥ `XMLHttpRequest` ï¼Œé‚£éœ€è¦åœ¨ `beforeunload` ä¸­åˆ›å»ºä¸€ä¸ªå›¾ç‰‡å…ƒç´ å¹¶è®¾ç½®å®ƒçš„ `src` å±æ€§çš„æ–¹æ³•æ¥å»¶è¿Ÿå¸è½½ä»¥ä¿è¯æ•°æ®çš„å‘é€ï¼Œå› ä¸ºç»å¤§å¤šæ•°æµè§ˆå™¨ä¼šå»¶è¿Ÿå¸è½½ä»¥ä¿è¯å›¾ç‰‡çš„è½½å…¥ï¼Œæ‰€ä»¥æ•°æ®å¯ä»¥åœ¨å¸è½½äº‹ä»¶ä¸­å‘é€ã€‚

ä½†æ— è®ºæ˜¯åŒæ­¥æˆ–è€…å¼‚æ­¥ï¼Œéƒ½ä¼šå»¶è¿Ÿå¸è½½å½“å‰é¡µé¢ï¼Œè€Œä½¿å¾—ä¸‹ä¸€ä¸ªé¡µé¢å‡ºç°å¾—æ›´æ™šã€‚

å› æ­¤ï¼Œæœ‰äº† [sendBeacon](https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon) æ–¹æ³•ã€‚`sendBeacon()` æ–¹æ³•ä¼šä½¿ç”¨æˆ·ä»£ç†åœ¨æœ‰æœºä¼šæ—¶å¼‚æ­¥åœ°å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼ŒåŒæ—¶ä¸ä¼šå»¶è¿Ÿé¡µé¢çš„å¸è½½æˆ–å½±å“ä¸‹ä¸€å¯¼èˆªçš„è½½å…¥æ€§èƒ½ã€‚è¿™å°±è§£å†³äº†æäº¤åˆ†ææ•°æ®æ—¶çš„æ‰€æœ‰çš„é—®é¢˜ï¼šæ•°æ®å¯é ï¼Œä¼ è¾“å¼‚æ­¥å¹¶ä¸”ä¸ä¼šå½±å“ä¸‹ä¸€é¡µé¢çš„åŠ è½½ã€‚

```js
window.addEventListener('unload', logData, false);

function reportData(url, data) {
    navigator.sendBeacon(url, blob);
}
```

`sendBeacon` å‘é€çš„ `data` ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š `ArrayBufferView`, `Blob`, `DOMString` æˆ– `Formdata`ã€‚

å‘é€ `Blob` æ•°æ®æ—¶ï¼Œéœ€æ‰‹åŠ¨ `MIME Type` ä¸º `application/x-www-form-urlencoded` ï¼Œ

```js
const reportData = (url, data) => {
    const blob = new Blob([
        JSON.stringify(data),
        {
            type: 'application/x-www-form-urlencoded'
        }
    ]);
    navigator.sendBeacon(url, blob);
};
```

## æ•°æ®æ ¼å¼

ä¸€èˆ¬æ¥è¯´ï¼Œä¸ŠæŠ¥çš„å•æ¡æ•°æ®éœ€è¦æœ‰ä»¥ä¸‹é€šç”¨å­—æ®µï¼š

-   `uuid` ã€‚æ•°æ®çš„å”¯ä¸€ idã€‚
-   æ•°æ®ç±»å‹ã€‚ `performance or error?` ç­‰ã€‚
-   å­ç±»å‹ã€‚ `fp`, `fcp`, `js error`, `resource error` ç­‰ã€‚
-   æ—¶é—´æˆ³ã€‚å‘ç”Ÿçš„æ—¶é—´ã€‚
-   é¡µé¢è·¯ç”±ã€‚
-   è®¾å¤‡ä¿¡æ¯ã€‚åŒ…æ‹¬è®¾å¤‡å’Œæµè§ˆå™¨ä¿¡æ¯ç­‰ã€‚
-   ç”¨æˆ·ä¿¡æ¯ã€‚

å…¶ä»–å­—æ®µæ ¹æ®åœºæ™¯å’Œéœ€æ±‚è€Œå®šã€‚åŒæ—¶è¿™äº›æ•°æ®éœ€è¦åŠ å¯†ã€‚

## ç›‘æ§å¹³å°

1. [sentry](https://github.com/getsentry/sentry)ï¼šä»ç›‘æ§é”™è¯¯ã€é”™è¯¯ç»Ÿè®¡å›¾è¡¨ã€å¤šé‡æ ‡ç­¾è¿‡æ»¤å’Œæ ‡ç­¾ç»Ÿè®¡åˆ°è§¦å‘å‘Šè­¦ï¼Œè¿™ä¸€æ•´å¥—éƒ½å¾ˆå®Œå–„ã€‚æ”¯æŒç§æœ‰åŒ–éƒ¨ç½²å’Œç›´æ¥ä½¿ç”¨ï¼Œç›´æ¥ä½¿ç”¨è¦æ”¶è´¹ï¼Œä¸”æ•°æ®é‡è¶Šå¤§é’±è¶Šè´µã€‚
2. [fundebug](https://www.fundebug.com/)ï¼šé™¤äº†ç›‘æ§é”™è¯¯ï¼Œè¿˜å¯ä»¥å½•å±ï¼Œä¹Ÿå°±æ˜¯è®°å½•é”™è¯¯å‘ç”Ÿçš„å‰å‡ ç§’ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œï¼Œå‹ç¼©åçš„ä½“ç§¯åªæœ‰å‡ å KBï¼Œä½†æ“ä½œç•¥å¾®ç¹ç
3. [webfunny](https://github.com/a597873885/webfunny_monitor)ï¼šä¹Ÿæ˜¯å«æœ‰ç›‘æ§é”™è¯¯çš„åŠŸèƒ½ï¼Œå¯ä»¥æ”¯æŒåƒä¸‡çº§åˆ«æ—¥ PV é‡ï¼Œé¢å¤–çš„äº®ç‚¹æ˜¯å¯ä»¥è¿œç¨‹è°ƒè¯•ã€æ€§èƒ½åˆ†æï¼Œä¹Ÿå¯ä»¥ docker ç§æœ‰åŒ–éƒ¨ç½²ï¼ˆå…è´¹ï¼‰ï¼Œä¸šåŠ¡ä»£ç åŠ å¯†è¿‡
4. [åº”ç”¨æ€§èƒ½ç›‘æ§å…¨é“¾è·¯ç‰ˆ](https://www.volcengine.com/products/apmplus)ï¼šå­—èŠ‚è·³åŠ¨ç›‘æ§å¹³å°ã€‚
5. [é˜¿é‡Œ Node.js æ€§èƒ½å¹³å°](https://www.aliyun.com/product/nodejs)ï¼šé¢å‘ä¸­å¤§å‹ `Node.js` åº”ç”¨æä¾›æ€§èƒ½ç›‘æ§ã€å®‰å…¨æé†’ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–ç­‰æœåŠ¡çš„æ•´ä½“æ€§è§£å†³æ–¹æ¡ˆã€‚
6. [å¬äº‘](https://www.tingyun.com/)
7. [mixpanel](https://mixpanel.com/)

å¼€æºåº“ï¼š

1. [rrweb](https://github.com/rrweb-io/rrweb) ï¼Œæä¾›åƒç´ çº§çš„å½•åˆ¶ä¸å›æ”¾ï¼Œå¸®åŠ©æ­£ç¡®å®šä½é—®é¢˜æ˜¯å¦‚ä½•å‘ç”Ÿçš„
2. [monitor](https://github.com/clouDr-f2e/monitor) ï¼ŒğŸ‘€ ä¸€æ¬¾è½»é‡çº§çš„æ”¶é›†é¡µé¢çš„ç”¨æˆ·ç‚¹å‡»è¡Œä¸ºã€è·¯ç”±è·³è½¬ã€æ¥å£æŠ¥é”™ã€ä»£ç æŠ¥é”™ã€å¹¶ä¸ŠæŠ¥æœåŠ¡ç«¯çš„ `SDK`
3. [mitojs](https://github.com/mitojs/mitojs) ï¼Œä¸Šé¢ `monitor` ä½œè€…æ–°ç»´æŠ¤çš„åº“ã€‚å…¨æ–°æ’æ‹”å¼çš„ç›‘æ§ `SDK` ï¼Œä»£ç æ¶æ„æ›´æ¸…æ™°ï¼Œé…ç½®é¡¹æ›´ä¸°å¯Œï¼Œé«˜åº¦å¯å®šåˆ¶åŒ–

## å‚è€ƒæ–‡ç« 

#### æ€§èƒ½ç›‘æ§

1. [ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„æ€§èƒ½æŒ‡æ ‡](https://web.dev/i18n/zh/user-centric-performance-metrics/)
2. [Custom metrics](https://web.dev/custom-metrics/)
3. [Cumulative Layout Shift ç´¯ç§¯å¸ƒå±€åç§» (CLS)](https://web.dev/cls/)
4. [Time to Interactive å¯äº¤äº’æ—¶é—´ (TTI)](https://web.dev/tti/)
5. [MDN Performance](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance)
6. [å¦‚ä½•ç»Ÿè®¡é¦–å±æ¸²æŸ“æ—¶é—´](https://juejin.cn/post/6962742206692065287)
7. [å‰ç«¯é¡µé¢æ€§èƒ½æŒ‡æ ‡ä¸é‡‡é›†æ–¹å¼](https://www.cnblogs.com/wmhuang/p/11156367.html)

#### é”™è¯¯ç›‘æ§

1. [å¯¹å‰ç«¯å¼‚å¸¸ window error æ•è·çš„å…¨é¢æ€»ç»“](https://www.cnblogs.com/liyongquan/p/9180562.html)
2. [[html] script çš„ crossorigin å±æ€§](https://www.jianshu.com/p/a45c9d089c93)

#### å…¶ä»–

1. [å‰ç«¯ç›‘æ§ SDK çš„ä¸€äº›æŠ€æœ¯è¦ç‚¹åŸç†åˆ†æ](https://juejin.cn/post/7017974567943536671)
2. [ä¸€ç¯‡è®²é€è‡ªç ”çš„å‰ç«¯é”™è¯¯ç›‘æ§](https://juejin.cn/post/6987681953424080926)
3. [æ­å»ºå‰ç«¯ç›‘æ§ç³»ç»Ÿ](https://www.yuque.com/xianjs/eg7dq1/vgeqbw#gN7tO)
4. [ä½¿ç”¨ sendBeacon è¿›è¡Œå‰ç«¯æ•°æ®ä¸ŠæŠ¥](https://www.jianshu.com/p/04e88271a8f2)
5. [å¦‚ä½•è¿›è¡Œ web æ€§èƒ½ç›‘æ§ï¼Ÿ](http://www.alloyteam.com/2020/01/14184/#prettyPhoto)
6. [èš‚èšé‡‘æœå¦‚ä½•æŠŠå‰ç«¯æ€§èƒ½ç›‘æ§åšåˆ°æè‡´?](https://www.infoq.cn/article/dxa8am44oz*lukk5ufhy)
